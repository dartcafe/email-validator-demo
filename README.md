# dartcafe/email-validator-demo

A small, dependency-light demo app showcasing the **dartcafe/email-validator** library.

- Single-file HTTP front controller, no framework
- Pretty UI for **validating emails**
- Built‑in editors for **lists.ini** and referenced blacklist/allowlist files
- Editor for **domain suggestions** (used for typo fixes)
- **Swagger UI** served locally (no external CDNs)
- Simple **rate limiter** to avoid abuse
- OpenAPI is generated by scanning **both** the library docs and the demo docs

> Requires **PHP 8.1+**. Recommended extensions: `intl` (IDN), `json` (std), `zip` (for import/export).

---

## Getting started

```bash
git clone https://github.com/dartcafe/email-validator-demo.git
cd email-validator-demo
composer install
composer run serve
# → http://127.0.0.1:8081
```

Default scripts (see `composer.json`):

```bash
composer run serve      # php -S 0.0.0.0:8081 -t public
composer run stop       # kills built-in server on :8081
composer run docs:assets# copy Swagger UI assets from vendor into public/docs/assets
composer run docs:sync  # build public/openapi.json (lib + demo)
composer run psalm      # static analysis
composer run cs         # code style (dry-run)
composer run cs:fix     # code style (apply)
```

---

## Endpoints

| Method | Path            | Description                                   |
| -----: | --------------- | --------------------------------------------- |
|    GET | `/`             | Demo UI (validator + list/suggestion editors) |
|    GET | `/health`       | Simple health check                           |
|    GET | `/validate`     | Validate via query: `?email=...`              |
|   POST | `/validate`     | Validate via JSON: `{ "email": "..." }`       |
|    GET | `/lists`        | Load `lists.ini` and all referenced files     |
|   POST | `/lists`        | Save `lists.ini` and referenced files         |
|    GET | `/lists/export` | Export lists as ZIP (or JSON fallback)        |
|   POST | `/lists/import` | Import ZIP or JSON (multipart or JSON body)   |
|    GET | `/suggestions`  | Read `config/suggestions.txt`                 |
|   POST | `/suggestions`  | Write `config/suggestions.txt`                |
|    GET | `/docs`         | Swagger UI                                    |
|    GET | `/openapi.json` | OpenAPI (generated file)                      |

- **Swagger UI** replaces servers dynamically with the **current host** (see `public/docs/index.html`), so it works on localhost and on deployed hosts without editing the spec.

---

## Lists & suggestions

### Lists (allow/deny)

- Configuration lives in `config/lists.ini`.
- Each section references a **text file** with one entry per line.
- Keys (case-insensitive):

```ini
[deny_disposable]
type       = deny          ; allow|deny
checkType  = domain        ; address|domain
listFileName = config/blacklists/disposable.txt
listName   = disposable    ; machine name (shows up in result)
humanName  = Disposable providers
```

The demo UI lets you edit `lists.ini`, all referenced files, and import/export bundles.

### Suggestions

- File: `config/suggestions.txt`
- One domain per line, `#` starts a comment.
- Used by the validator’s **suggestion provider** to propose typo fixes.
- You can choose the **distance metric** (Levenshtein or Damerau–Levenshtein) in the underlying library when wiring the validator; the demo uses the library defaults.

---

## Rate limiting

A tiny file‑based token bucket protects the public endpoints.

Environment variables (optional):

- `RATE_MODE` – `global` (one shared bucket) or `ip` (per client IP). Default: `global`
- `RATE_CAPACITY` – Max tokens in bucket. Default: `60`
- `RATE_REFILL` – Tokens per second. Default: `1.0`
- `RATE_DIR` – Directory to store limiter state. Default: `var/rate`

Example:

```bash
RATE_MODE=ip RATE_CAPACITY=30 RATE_REFILL=2.0 composer run serve
```

---

## OpenAPI generation (demo)

The demo builds a **single** `public/openapi.json` by scanning:

1. the **library’s** docs (installed in `vendor/dartcafe/email-validator/docs`), and
2. the **demo’s** docs (`src/Demo/Docs`).

Run:

```bash
composer run docs:assets   # once after install/update
composer run docs:sync     # re-generate openapi.json
```

The script `scripts/sync-openapi.php`:

- loads Composer autoload,
- **force-loads all doc classes** from both directories (attributes need reflection),
- calls `vendor/bin/openapi` to generate `public/openapi.json`.

If you only see the library endpoints in Swagger:

- ensure `src/Demo/Docs` exists (case-sensitive),
- run `composer dump-autoload -o`,
- re-run `composer run docs:sync`.

---

## Deployment

**No framework** involved – just point your web server’s docroot to `public/`.

### Apache (example)

```apache
DocumentRoot /var/www/email-validator-demo/public

<Directory /var/www/email-validator-demo/public>
    AllowOverride All
    Require all granted
    FallbackResource /index.php
</Directory>
```

### Nginx (PHP-FPM, example)

```nginx
server {
  listen 80;
  server_name demo.example.com;

  root /var/www/email-validator-demo/public;
  index index.php;

  location / {
    try_files $uri /index.php?$query_string;
  }

  location ~ \.php$ {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.2-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
  }
}
```

### Minimal production steps

```bash
git clone https://github.com/dartcafe/email-validator-demo.git
cd email-validator-demo
composer install --no-dev --optimize-autoloader
composer run docs:assets
composer run docs:sync
# ensure web server points to ./public
# ensure ./var is writable (for rate limiter)
```

---

## Development

```bash
composer run psalm
composer run cs
composer run cs:fix
```

---

## Troubleshooting

- **Swagger UI shows only `/health` and `/validate`:**
  Run `composer run docs:sync`. Check that `src/Demo/Docs` classes are autoloadable (`composer dump-autoload -o`).

- **“Skipping unknown … Required @OA\Info() not found”**
  Ensure the lib docs are installed (`vendor/dartcafe/email-validator/docs`) and the sync script is loading them (it should force-load all PHP files).

- **Rate limiter blocks too aggressively**
  Tune `RATE_CAPACITY` / `RATE_REFILL`; switch to `RATE_MODE=ip` for per-client buckets.

---

## License & third‑party notices

- Demo: **MIT** © René Gieling
- Swagger UI assets (Apache‑2.0) are copied into `public/docs/assets`.
  Their LICENSE/NOTICE files are mirrored in `public/docs/assets/THIRD-PARTY-NOTICES/`.

See [LICENSE](./LICENSE).
